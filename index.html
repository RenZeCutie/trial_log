<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lune OS | Integrated Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ========================================
            GLOBAL & RESET (UNTOUCHED)
           ======================================== */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #050505; 
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #D4AF37;
        }

        #cursorGlow {
            position: fixed;
            top: 0;
            left: 0;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.12) 0%, rgba(212, 175, 55, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1; 
            transform: translate(-50%, -50%);
            transition: opacity 1.5s ease;
            opacity: 0; 
        }
        @media (max-width: 769px) { #cursorGlow { width: 300px; height: 300px; } }

        #starCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .main-wrapper {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 300%; 
            transition: transform 1.1s cubic-bezier(0.85, 0, 0.15, 1);
            display: flex;
            flex-direction: column;
        }

        .slide-to-selection { transform: translateY(-33.333%); }
        .slide-to-portal { transform: translateY(-66.666%); }

        section {
            width: 100%;
            height: 33.333%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .login-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('logomain.png'); 
            background-size: 40%;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(60px) brightness(0.4);
            opacity: 0.8;
            z-index: 0;
        }

        .splash-container {
            display: flex;
            flex-direction: column; 
            align-items: center;
            position: relative;
        }

        .splash-glow-ring {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            width: 350px; height: 350px;
            border-radius: 50%;
            box-shadow: 0 0 80px rgba(212, 175, 55, 0.3); 
            animation: pulse 4s infinite alternate;
            z-index: -1;
        }

        .logo {
            max-width: 250px; 
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.2));
            animation: moveUp 3s ease-out forwards;
        }

        .typography-img {
            max-width: 100px; 
            margin-top: -5px;
            opacity: 0;
            animation: fadeInText 2s ease-out 1.5s forwards;
        }

        .login-box {
            position: relative;
            z-index: 5;
            text-align: center;
            color: #D4AF37;
            background: rgba(255, 255, 255, 0.03);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            min-width: 320px;
        }

        .portal-content { display: none; }

        input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(212, 175, 55, 0.4);
            color: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            width: 250px;
            outline: none;
            transition: 0.3s;
        }

        input:focus {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.05); 
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            transform: translateY(-2px); 
        }
        
        button {
            background: #D4AF37;
            border: none;
            padding: 12px 30px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px;
            color: #050505;
            margin-top: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
         }

        button:hover {
            transform: scale(1.1); 
            background: #fff; 
            color: #000;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.8), 0 0 30px rgba(212, 175, 55, 0.4);
         }

        button:active { transform: scale(0.95); }

        .secondary-btn { background: transparent; border: 1px solid #D4AF37; color: #D4AF37; margin-left: 5px; }

        .back-link {
            display: block; margin-top: 15px; font-size: 0.8rem;
            color: rgba(212, 175, 55, 0.6); cursor: pointer; text-decoration: underline;
        }

        /* DASHBOARD STYLES */
        #dashboard-view {
            display: none; 
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            z-index: 100;
        }

        #mainLogoContainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            transition: all 1.5s cubic-bezier(0.85, 0, 0.15, 1);
        }

        @media (min-width: 770px) {
            body.is-logged-in #mainLogoContainer {
                top: 5px;
                left: 160px; 
                transform: translate(-50%, 0) scale(0.55);
            }
        }

        @media (max-width: 769px) {
            body.is-logged-in #mainLogoContainer {
                top: 20px;
                left: 50%;
                transform: translate(-50%, 0) scale(0.35);
            }
        }

        .dash-glow-ring {
            position: absolute; 
            top: 45%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            width: 350px; 
            height: 350px; 
            border-radius: 50%;
            box-shadow: 0 0 80px rgba(212, 175, 55, 0.3);
            animation: pulse 4s infinite alternate; 
            z-index: -1;
        }

        @media (max-width: 769px) { .dash-glow-ring { width: 200px; height: 200px; } }

        .logo-splash {
            max-width: 200px;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.2));
            animation: moveUp 3s ease-out forwards;
        }

        .member-text {
            max-width: 120px;
            height: auto;
            margin-top: 10px;
            opacity: 0;
            filter: drop-shadow(0 0 10px rgba(212, 175, 55, 0.4));
            animation: fadeInText 2s ease-out 1.5s forwards;
        }

        .sidebar { 
            width: 260px; 
            border-right: 1px solid rgba(212, 175, 55, 0.2); 
            padding: 30px; 
            display: flex; 
            flex-direction: column;
            z-index: 10;
            background: rgba(5, 5, 5, 0); 
            backdrop-filter: blur(0px);
            transition: backdrop-filter 2s ease, background 2s ease; 
        }

        body.is-logged-in .sidebar {
            background: rgba(5, 5, 5, 0.6);
            backdrop-filter: blur(8px);
        }

        @media (max-width: 769px) { .sidebar { display: none; } }

        .profile-card {
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(212, 175, 55, 0.2);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(12px); 
            min-width: 400px;
            z-index: 10;
        }

        #memberDashboard {
            display: flex; 
            height: 100vh; 
            opacity: 0; 
            visibility: hidden;
            transition: opacity 1.5s ease 1s;
        }

        body.is-logged-in #memberDashboard { 
            opacity: 1; 
            visibility: visible;
        }

        .main { 
            flex: 1; 
            padding: 50px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        .profile-id { font-family: monospace; color: rgba(255, 255, 255, 0.5); font-size: 0.8rem; margin-top: 10px; }
        .status-badge { color: #00ff00; font-size: 0.7rem; border: 1px solid #00ff00; padding: 4px 10px; display: inline-block; margin-top: 20px; }

        .btn-exit { background: none; border: 1px solid #D4AF37; color: #D4AF37; padding: 8px 20px; cursor: pointer; margin-top: auto; transition: 0.3s; width: 100%; font-size: 0.8rem; letter-spacing: 2px; }
        .btn-exit:hover { background: #D4AF37; color: #000; }

        .btn-exit-mobile { display: none; background: none; border: 1px solid #D4AF37; color: #D4AF37; padding: 12px 20px; cursor: pointer; transition: 0.3s; margin: 20px auto 0; font-size: 0.75rem; letter-spacing: 3px; }

        @keyframes moveUp { 0% { transform: scale(0.8) translateY(0); opacity: 0; } 100% { transform: scale(1) translateY(-15px); opacity: 1; } }
        @keyframes fadeInText { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; } 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.6; } }

        /* ========================================
            SPECIFIC MOBILE FIXES
           ======================================== */
        @media (max-width: 769px) {
            .main {
                justify-content: flex-start; 
                padding-top: 200px;         
                padding-bottom: 100px;       
            }

            .profile-card { 
                min-width: 0; 
                width: calc(100% - 60px); 
                padding: 25px 20px; 
                margin: 0 auto; 
            }
            
            #memberName {
                font-size: 1.8rem !important; 
            }

            .btn-exit-mobile { 
                display: block !important;  
                margin: 30px auto 0;          
                width: 70%;                 
            }
        }
    </style>
</head>
<body>

    <div id="cursorGlow"></div>
    <canvas id="starCanvas"></canvas>

    <div class="main-wrapper" id="masterWrapper">
        <section class="page-splash" onclick="goToSelection()">
            <div class="splash-container">
                <div class="splash-glow-ring"></div>
                <img src="logomain.png" alt="Lune OS Logo" class="logo">
                <img src="logo.png" alt="Lune OS Text" class="typography-img">
            </div>
        </section>

        <section class="page-selection">
            <div class="login-bg"></div>
            <div class="login-box">
                <h2>MEMBERSHIP PORTAL</h2>
                <div style="margin-top: 20px;">
                    <button id="btnContinue" onclick="openPortal('member')">CONTINUE</button>
                </div>
            </div>
        </section>

        <section class="page-portal">
            <div class="login-bg"></div>
            <div id="memberLoginForm" class="portal-content login-box">
                <h2>MEMBER LOGIN</h2>
                <input type="email" id="loginEmail" placeholder="Email Address">
                <input type="password" id="loginPass" placeholder="Password">
                <br>
                <button onclick="memberLogin()">Login</button>
                <button class="secondary-btn" onclick="toggleMemberView('register')">Register</button>
                <span class="back-link" onclick="goBackToSelection()">Go Back</span>
            </div>

            <div id="memberRegisterForm" class="portal-content login-box">
                <h2>CREATE ACCOUNT</h2>
                <input type="text" id="regName" placeholder="Display Name">
                <input type="email" id="regEmail" placeholder="Active Email">
                <input type="password" id="regPass" placeholder="New Password">
                <input type="password" id="regPassConfirm" placeholder="Re-enter Password">
                <br>
                <button onclick="memberRegister()">Register</button>
                <button class="secondary-btn" onclick="toggleMemberView('login')">Back</button>
            </div>
        </section>
    </div>

    <div id="dashboard-view">
        <div id="mainLogoContainer">
            <div class="dash-glow-ring"></div>
            <img src="logomain.png" alt="Lune OS Logo" class="logo-splash">
            <img src="logo.png" alt="Admin Core" class="member-text">
        </div>

       <div id="memberDashboard">
    <div class="sidebar">
        <div style="height: 250px;"></div> 
        <button class="btn-exit" onclick="logoutSession()">LOG OUT</button>
    </div>

    <div class="main">
        <div class="profile-card">
            <h2 style="letter-spacing: 5px; font-weight: 300; margin-bottom: 5px;">MEMBER IDENTITY</h2>
            <hr style="border: 0; border-top: 1px solid rgba(212, 175, 55, 0.2); margin: 20px 0;">
            
            <h1 id="memberName" style="font-size: 2.5rem; margin: 10px 0;">USER NAME</h1>
            <div id="memberId" class="profile-id">LOADING TIME...</div>
            
            <div id="statusBadge" 
                 class="status-badge" 
                 onclick="toggleSession()" 
                 style="cursor: pointer; transition: all 0.3s ease; user-select: none;">
                 SESSION: ACTIVE
            </div>
            
            <div id="sessionHint" style="font-size: 0.6rem; color: rgba(172, 162, 127, 0.5); margin-top: 8px; letter-spacing: 1px; text-transform: uppercase;">
                 click only if finishing session
            </div>
        </div>

        <button class="btn-exit-mobile" onclick="logoutSession()">LOG OUT</button>
    </div>
</div>

    <script>
        const SUPABASE_URL = 'https://urjktkgiskdrbnbraeyu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyamt0a2dpc2tkcmJuYnJhZXl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0ODU4NjUsImV4cCI6MjA4NTA2MTg2NX0.pNGwa2vGQVJXR7mUwRuQ7VfLw_Y8j6h3dtHdIVO7Vgk'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const wrapper = document.getElementById('masterWrapper');
        const dashboardView = document.getElementById('dashboard-view');
        
        // --- VISUALS (UNTOUCHED) ---
        const canvas = document.getElementById('starCanvas');
        const ctx = canvas.getContext('2d');
        const glow = document.getElementById('cursorGlow');
        let mouseX = 0, mouseY = 0, ballX = 0, ballY = 0;
        window.addEventListener('mousemove', (e) => { glow.style.opacity = "1"; mouseX = e.clientX; mouseY = e.clientY; });
        function animateGlow() { ballX += (mouseX - ballX) * 0.08; ballY += (mouseY - ballY) * 0.08; glow.style.left = ballX + 'px'; glow.style.top = ballY + 'px'; requestAnimationFrame(animateGlow); }
        animateGlow();
        let particles = [];
        function initParticles() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; particles = []; const count = window.innerWidth < 770 ? 60 : 120; for (let i = 0; i < count; i++) { particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: Math.random() * 1.5 + 0.5, speed: Math.random() * 0.4 + 0.1, opacity: Math.random() }); } }
        function animateParticles() { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "rgba(212, 175, 55, 0.7)"; particles.forEach(p => { ctx.globalAlpha = p.opacity; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill(); p.y -= p.speed; if (p.y < 0) p.y = canvas.height; }); requestAnimationFrame(animateParticles); }
        window.addEventListener('resize', initParticles); initParticles(); animateParticles();

        // --- NEW: RECOGNITION & LOGGING HELPERS ---
        
        // Generates a simple device fingerprint stored in localStorage
        function getDeviceFingerprint() {
            let fingerprint = localStorage.getItem('lune_device_id');
            if (!fingerprint) {
                fingerprint = 'device-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
                localStorage.setItem('lune_device_id', fingerprint);
            }
            return fingerprint;
        }

        async function recordUserActivity(user) {
            const fingerprint = getDeviceFingerprint();
            const today = new Date().toISOString().split('T')[0];

            // 1. Record/Recognize Device
            await supabaseClient.from('user_devices').upsert({
                user_id: user.id,
                device_fingerprint: fingerprint,
                device_name: navigator.platform || 'Web Browser',
                last_login: new Date().toISOString(),
                is_trusted: true
            }, { onConflict: 'device_fingerprint' });

            // 2. Record Daily Log (Once per day)
            const { data: existingLog } = await supabaseClient
                .from('workout_logs')
                .select('log_id')
                .eq('user_id', user.id)
                .eq('date', today)
                .single();

            if (!existingLog) {
                await supabaseClient.from('workout_logs').insert({
                    user_id: user.id,
                    date: today,
                    notes: 'User session recorded via Portal'
                });
            }
        }

        // --- NAVIGATION LOGIC (UPDATED WITH AUTO-LOGIN) ---
        function goToSelection() { wrapper.classList.add('slide-to-selection'); }
        function goBackToSelection() { wrapper.classList.remove('slide-to-portal'); }
        
        async function openPortal(type) {
            if (type === 'member') {
                const btn = document.getElementById('btnContinue');
                btn.innerText = "VERIFYING...";

                // AUTO-LOGIN RECOGNITION
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    const { data: userData } = await supabaseClient.from('users').select('full_name').eq('user_id', session.user.id).single();
                    await recordUserActivity(session.user);
                    switchToDashboard(userData ? userData.full_name : 'Member');
                    return;
                }

                // If no session, show login form
                btn.innerText = "CONTINUE";
                document.querySelectorAll('.portal-content').forEach(el => el.style.display = 'none');
                document.getElementById('memberLoginForm').style.display = 'block';
            }
            wrapper.classList.add('slide-to-portal');
        }

        function toggleMemberView(view) {
            document.getElementById('memberLoginForm').style.display = view === 'login' ? 'block' : 'none';
            document.getElementById('memberRegisterForm').style.display = view === 'register' ? 'block' : 'none';
        }

        // --- AUTH LOGIC (ALIGNED WITH DATABASE SCHEMA) ---
        async function memberRegister() {
            const email = document.getElementById('regEmail').value.trim();     
            const password = document.getElementById('regPass').value;
            const confirm = document.getElementById('regPassConfirm').value;
            const fullName = document.getElementById('regName').value.trim();

            if (!email || !password || !fullName) { alert("Please fill in all fields."); return; }
            if (password !== confirm) { alert("Passwords do not match!"); return; }

            // 1. Create Auth User
            const { data, error } = await supabaseClient.auth.signUp({ email, password });

            if (error) { 
                alert("Registration Error: " + error.message); 
            } 
            else if (data.user) {
                // 2. Insert into your 'users' table (matches your screenshot columns)
                const { error: dbError } = await supabaseClient.from('users').insert([{ 
                    user_id: data.user.id, 
                    full_name: fullName, 
                    email: email 
                    // password_hash is usually handled by Supabase Auth internally, 
                    // but if your table requires it, you'd handle it here.
                }]);

                if (dbError) {
                    console.error("Database sync error:", dbError.message);
                }

                await recordUserActivity(data.user);
                alert("Registration Successful!");
                toggleMemberView('login');
            }
        }

        async function memberLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPass').value;
            const btn = document.querySelector("#memberLoginForm button");

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) { 
                alert("Login Failed: " + error.message); 
            } 
            else {
                // Fetch using 'full_name' to match your DB schema
                const { data: userData } = await supabaseClient.from('users')
                    .select('full_name')
                    .eq('user_id', data.user.id)
                    .single();
                
                await recordUserActivity(data.user);
                
                const displayName = userData ? userData.full_name : 'Explorer';
                btn.innerText = "ACCESS GRANTED...";
                btn.style.background = "#00ff00";
                btn.style.color = "#000";

                setTimeout(() => { switchToDashboard(displayName); }, 800);
            }
        }

        // --- DASHBOARD LOGIC (UNTOUCHED) ---
        function switchToDashboard(userName) {
            wrapper.style.display = 'none';
            document.getElementById('memberName').innerText = userName.toUpperCase();
            startRealTimeClock();
            dashboardView.style.display = 'block';
            setTimeout(() => { document.body.classList.add('is-logged-in'); }, 100);
        }

        function startRealTimeClock() {
            const timeElement = document.getElementById('memberId');
            function update() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
                timeElement.innerText = `${timeString} | ${dateString.toUpperCase()}`;
            }
            update(); setInterval(update, 1000);
        }

        async function logoutSession() {
             await supabaseClient.auth.signOut();
             location.reload();
        }

    function toggleSession() {
    const badge = document.getElementById('statusBadge');
    const hint = document.getElementById('sessionHint');
    
    // Check current state
    if (badge.innerText === "SESSION: ACTIVE") {
        // Switch to FINISHED
        badge.innerText = "SESSION: FINISHED";
        badge.style.color = "#ff0000";
        badge.style.borderColor = "#ff0000";
        hint.style.opacity = "0"; // Mute the hint instead of display:none to prevent layout jump
    } else {
        // Switch back to ACTIVE
        badge.innerText = "SESSION: ACTIVE";
        badge.style.color = "#00ff00"; // Original green
        badge.style.borderColor = "#00ff00";
        hint.style.opacity = "1"; // Show hint again
    }
}
    </script>
</body>
</html>

